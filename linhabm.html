<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RailTrack - Sistema Ferrovi√°rio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --secondary: #10b981;
      --accent: #f59e0b;
      --danger: #ef4444;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 10px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: var(--dark);
      min-height: 100vh;
    }
    
    .tela-cadastro {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(145deg, #1e3a8a, #1e40af);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.5s ease;
    }
    
    .tela-cadastro.oculto {
      opacity: 0;
      pointer-events: none;
    }
    
    .cartao-cadastro {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      padding: 40px;
      border-radius: 20px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: surgir 0.8s ease;
    }
    
    @keyframes surgir {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tela-selecao-rota {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #1e3a8a, #1e40af);
      z-index: 10001;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: aparecer 0.5s ease;
    }
    
    .opcao-rota {
      background: rgba(255, 255, 255, 0.08);
      padding: 20px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 20px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      margin-bottom: 15px;
      width: 100%;
      max-width: 380px;
    }
    
    .opcao-rota:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-3px);
    }
    
    .opcao-rota.selecionada {
      border-color: #60a5fa;
      background: rgba(96, 165, 250, 0.15);
      box-shadow: 0 8px 20px rgba(96, 165, 250, 0.2);
    }
    
    .icone-rota {
      font-size: 2.5rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }
    
    .conteudo-principal {
      display: none;
    }
    
    .conteudo-principal.ativo {
      display: block;
    }
    
    .cabecalho {
      background: white;
      box-shadow: var(--shadow);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .titulo-pagina {
      text-align: center;
      flex: 1;
    }
    
    .titulo-pagina h1 {
      font-size: 1.2rem;
      color: var(--primary);
      font-weight: 600;
    }
    
    .subtitulo {
      font-size: 0.75rem;
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 3px;
    }
    
    .botao-menu {
      background: none;
      border: none;
      font-size: 1.4rem;
      color: var(--primary);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    
    .botao-menu:hover {
      background: #f1f5f9;
    }
    
    .botao-atualizar {
      background: var(--primary);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .botao-atualizar:hover {
      background: var(--primary-light);
      transform: rotate(180deg);
    }
    
    .area-conteudo {
      position: fixed;
      top: 70px;
      bottom: 0;
      left: 0;
      right: 0;
      overflow-y: auto;
      padding: 20px;
      background: var(--light);
    }
    
    .cartao-atualizacao {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 15px;
      animation: deslizar 0.4s ease;
      border-left: 4px solid var(--secondary);
    }
    
    @keyframes deslizar {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .cartao-atualizacao.nova {
      border-left-color: var(--accent);
      background: linear-gradient(to right, rgba(245, 158, 11, 0.05), white);
    }
    
    .remetente {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }
    
    .data-hora {
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    .conteudo-mensagem {
      margin: 12px 0;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .acoes-mensagem {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }
    
    .botao-acao {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    
    .botao-acao:hover {
      background: #f1f5f9;
    }
    
    .botao-acao.copiar:hover {
      color: var(--secondary);
    }
    
    .botao-acao.compartilhar:hover {
      color: var(--primary);
    }
    
    .indicador-online {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      z-index: 1002;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .ponto-online {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulsar 2s infinite;
    }
    
    @keyframes pulsar {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .botao-conversa {
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 60px;
      height: 60px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .botao-conversa:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }
    
    .badge-conversa {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tela-conversa {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #e5e7eb;
      z-index: 1100;
      flex-direction: column;
    }
    
    .cabecalho-conversa {
      background: var(--primary);
      color: white;
      padding: 18px;
      text-align: center;
      font-weight: 500;
      position: relative;
    }
    
    .area-mensagens {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #e5e7eb;
    }
    
    .mensagem {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      margin-bottom: 10px;
      word-wrap: break-word;
    }
    
    .mensagem.enviada {
      background: #d1fae5;
      align-self: flex-end;
      margin-left: auto;
    }
    
    .mensagem.recebida {
      background: white;
      align-self: flex-start;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .entrada-conversa {
      padding: 15px;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }
    
    #campo-mensagem {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid var(--border);
      border-radius: 25px;
      outline: none;
      font-size: 0.95rem;
    }
    
    #enviar-mensagem {
      background: var(--secondary);
      color: white;
      border: none;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
    }
    
    .confirmacao-copia {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--secondary);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      box-shadow: var(--shadow);
      z-index: 1200;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .notificacao-nova {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 14px 28px;
      border-radius: 25px;
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.2);
      z-index: 1001;
      display: none;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    
    .carregando {
      display: flex;
      justify-content: center;
      padding: 40px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: girar 1s linear infinite;
    }
    
    @keyframes girar {
      to { transform: rotate(360deg); }
    }
    
    .menu-lateral {
      position: fixed;
      top: 0;
      right: -300px;
      width: 280px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 15px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      padding-top: 80px;
    }
    
    .menu-lateral.ativo {
      right: 0;
    }
    
    .item-menu {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
    }
    
    .item-menu:hover {
      background: #f8fafc;
      padding-left: 30px;
    }
    
    .sobreposicao {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      display: none;
    }
    
    .sobreposicao.ativo {
      display: block;
    }
    
    .rodape {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-size: 0.85rem;
      border-top: 1px solid var(--border);
      margin-top: 30px;
    }
    
    @media (max-width: 768px) {
      .area-conteudo {
        padding: 15px;
      }
      
      .cartao-cadastro {
        padding: 30px 25px;
        margin: 0 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Tela de Cadastro Inicial -->
  <div class="tela-cadastro" id="telaCadastro">
    <div class="cartao-cadastro">
      <h1 style="text-align: center; margin-bottom: 8px;">RailTrack</h1>
      <p style="text-align: center; opacity: 0.9; margin-bottom: 25px;">Sistema Ferrovi√°rio Inteligente</p>
      
      <input id="campoNome" placeholder="Nome completo" style="width:100%; margin-bottom:15px; padding:14px; border-radius:10px; border:none; background:rgba(255,255,255,0.12); color:white; outline:none;">
      <input id="campoTelefone" placeholder="+258 84xxxxxxx" style="width:100%; margin-bottom:25px; padding:14px; border-radius:10px; border:none; background:rgba(255,255,255,0.12); color:white; outline:none;">
      
      <button onclick="processarRegistro()" style="width:100%; padding:15px; background:linear-gradient(135deg, #3b82f6, #1d4ed8); color:white; border:none; border-radius:10px; font-weight:600; cursor:pointer; transition:transform 0.2s;">
        Entrar no Sistema
      </button>
      
      <div id="indicadorCarregando" style="display:none; flex-direction:column; align-items:center; margin-top:20px;">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-size:0.9rem;">Processando...</p>
      </div>
    </div>
  </div>
  
  <!-- Tela de Sele√ß√£o de Rota -->
  <div class="tela-selecao-rota" id="telaSelecaoRota">
    <div class="cartao-cadastro">
      <h1 style="text-align: center; margin-bottom: 10px;">Escolha sua Rota</h1>
      <p style="text-align: center; opacity: 0.9; margin-bottom: 30px;">
        Selecione a linha ferrovi√°ria que deseja acompanhar
      </p>
      
      <div id="containerRotas">
        <!-- Op√ß√µes ser√£o inseridas dinamicamente -->
      </div>
      
      <button onclick="confirmarSelecaoRota()" style="width:100%; margin-top:30px; padding:15px; background:linear-gradient(135deg, #3b82f6, #1d4ed8); color:white; border:none; border-radius:10px; font-weight:600; cursor:pointer;">
        <i class="fas fa-train"></i> Acessar Rota
      </button>
    </div>
  </div>
  
  <!-- Conte√∫do Principal -->
  <div class="conteudo-principal" id="conteudoPrincipal">
    <div class="indicador-online" id="indicadorOnline">
      <div class="ponto-online"></div>
      <span>Online</span>
    </div>
    
    <div class="notificacao-nova" id="notificacaoNova">
      <i class="fas fa-bell"></i>
      <span id="textoNotificacao">Nova atualiza√ß√£o!</span>
    </div>
    
    <div class="cabecalho">
      <button class="botao-menu" id="botaoMenu">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="titulo-pagina" id="tituloPagina">
        <h1 id="nomeRota">RailTrack</h1>
        <div class="subtitulo" id="ultimaAtualizacao">
          <i class="fas fa-clock"></i>
          <span>√öltima verifica√ß√£o: --:--</span>
        </div>
      </div>
      
      <button class="botao-atualizar" id="botaoAtualizar" title="Atualizar informa√ß√µes">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
    
    <div class="area-conteudo" id="areaConteudo">
      <div class="carregando" id="indicadorCarregamento">
        <div class="spinner"></div>
      </div>
      
      <div id="containerAtualizacoes">
        <!-- Atualiza√ß√µes ser√£o carregadas aqui -->
      </div>
    </div>
    
    <button class="botao-conversa" id="botaoConversa" title="Abrir conversa">
      <i class="fas fa-comment-dots"></i>
      <div class="badge-conversa" id="badgeConversa" style="display: none;">0</div>
    </button>
    
    <div class="confirmacao-copia" id="confirmacaoCopia">
      <i class="fas fa-check"></i>
      <span>Copiado para √°rea de transfer√™ncia</span>
    </div>
    
    <!-- Tela de Conversa -->
    <div class="tela-conversa" id="telaConversa">
      <div class="cabecalho-conversa">
        <button onclick="fecharConversa()" style="position:absolute; left:20px; background:none; border:none; color:white; font-size:1.4rem; cursor:pointer;">
          <i class="fas fa-arrow-left"></i>
        </button>
        <span id="tituloConversa">Conversa</span>
      </div>
      
      <div class="area-mensagens" id="areaMensagens">
        <div class="carregando">
          <div class="spinner"></div>
        </div>
      </div>
      
      <div class="entrada-conversa">
        <input type="text" id="campo-mensagem" placeholder="Digite sua mensagem..." maxlength="300">
        <button id="enviar-mensagem">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
    
    <!-- Menu Lateral -->
    <div class="menu-lateral" id="menuLateral">
      <div class="item-menu" onclick="window.location.href='estacoes.html'">
        <i class="fas fa-map-marker-alt"></i>
        <span>Esta√ß√µes</span>
      </div>
      <div class="item-menu" onclick="window.location.href='horarios.html'">
        <i class="fas fa-clock"></i>
        <span>Hor√°rios</span>
      </div>
      <div class="item-menu" onclick="window.location.href='sobre.html'">
        <i class="fas fa-info-circle"></i>
        <span>Sobre o Sistema</span>
      </div>
      <div class="item-menu" onclick="window.location.href='estatisticas.html'">
        <i class="fas fa-chart-line"></i>
        <span>Estat√≠sticas</span>
      </div>
      <div class="item-menu" onclick="window.location.href='ajuda.html'">
        <i class="fas fa-question-circle"></i>
        <span>Ajuda</span>
      </div>
      <div class="item-menu" onclick="exibirInfoUsuario()">
        <i class="fas fa-user-circle"></i>
        <span>Meu Perfil</span>
      </div>
      <div class="item-menu" onclick="trocarRotaAtual()">
        <i class="fas fa-exchange-alt"></i>
        <span>Trocar de Rota</span>
      </div>
      <div class="item-menu" onclick="sairDoSistema()" style="color: var(--danger);">
        <i class="fas fa-sign-out-alt"></i>
        <span>Sair</span>
      </div>
    </div>
    
    <div class="sobreposicao" id="sobreposicao"></div>
  </div>

  <script>
    // ============================================
    // CONFIGURA√á√ïES DO SISTEMA
    // ============================================
    const URL_SERVIDOR = "https://script.google.com/macros/s/AKfycbyQV8I5Ps7fgjQ-d5u_XfVVgKkB8n8O2pi6tfkFUPJY9lGR9ZLZOlhJwO99Z936dOVc/exec";
    
    const ROTAS = {
        'tr_mz': {
            id: 'tr_mz',
            nome: 'Beira - Moatize',
            simbolo: 'üöÇ',
            cor: '#1e40af'
        },
        'tr_mr': {
            id: 'tr_mr',
            nome: 'Beira - Marromeu',
            simbolo: 'üöÜ',
            cor: '#10b981'
        },
        'tr_ch': {
            id: 'tr_ch',
            nome: 'Beira - Chimoio',
            simbolo: 'üöÑ',
            cor: '#8b5cf6'
        }
    };
    
    let contadorAtualizacoesAnterior = 0;
    let usuarioAtual = "";
    let rotaSelecionada = null;
    let intervaloAtualizacao = null;
    let ultimaMensagemConversa = 0;
    
    // ============================================
    // FUN√á√ïES DE UTILIDADE
    // ============================================
    function exibirMensagemRapida(texto, tipo = 'info') {
        const mensagem = document.createElement('div');
        mensagem.className = 'mensagem-rapida';
        mensagem.innerHTML = texto;
        
        const cor = tipo === 'sucesso' ? '#10b981' : 
                   tipo === 'erro' ? '#ef4444' : '#3b82f6';
        
        mensagem.style.cssText = `
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: ${cor};
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            z-index: 10000;
            animation: surgir 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            font-weight: 500;
        `;
        
        document.body.appendChild(mensagem);
        
        setTimeout(() => {
            if (mensagem.parentNode) {
                mensagem.remove();
            }
        }, 3000);
    }
    
    function validarNomeUsuario(nome) {
        const partes = nome.trim().split(/\s+/);
        return /^[A-Za-z√Ä-√ø ]+$/.test(nome) && partes.length <= 3 && partes[0].length >= 2;
    }
    
    function validarNumeroTelefone(numero) {
        const limpo = numero.replace(/\D/g, '');
        return /^(?:258)?(82|83|84|85|86|87)\d{7}$/.test(limpo);
    }
    
    function gerarIdPassageiro(nomeCompleto, telefone) {
        const primeiroNome = nomeCompleto.trim().split(/\s+/)[0];
        const numeroLimpo = telefone.replace(/\D/g, '').replace(/^258/, '');
        return `${primeiroNome}_${numeroLimpo}`;
    }
    
    // ============================================
    // CADASTRO INICIAL DO USU√ÅRIO
    // ============================================
    async function processarRegistro() {
        const campoNome = document.getElementById("campoNome");
        const campoTelefone = document.getElementById("campoTelefone");
        const indicador = document.getElementById("indicadorCarregando");
        
        const nome = campoNome.value.trim();
        let telefone = campoTelefone.value.trim();
        
        if (!validarNomeUsuario(nome)) {
            exibirMensagemRapida("Nome inv√°lido. Use apenas letras (at√© 3 nomes).", "erro");
            campoNome.focus();
            return;
        }
        
        telefone = telefone.replace(/\D/g, '');
        if (telefone.length === 9) {
            telefone = '258' + telefone;
        }
        
        if (!validarNumeroTelefone(telefone)) {
            exibirMensagemRapida("N√∫mero inv√°lido. Formato: 84xxxxxxx", "erro");
            campoTelefone.focus();
            return;
        }
        
        indicador.style.display = "flex";
        
        try {
            const dadosFormulario = new URLSearchParams();
            dadosFormulario.append('acao', 'registrar_passageiro');
            dadosFormulario.append('nome', nome);
            dadosFormulario.append('telefone', telefone);
            
            const resposta = await fetch(URL_SERVIDOR, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: dadosFormulario.toString()
            });
            
            const resultado = await resposta.json();
            
            if (resultado.sucesso) {
                const idUsuario = resultado.id_usuario || gerarIdPassageiro(nome, telefone);
                
                const dadosUsuario = {
                    nome: nome,
                    telefone: telefone,
                    id_usuario: idUsuario,
                    data_registro: new Date().toISOString()
                };
                
                localStorage.setItem("dados_passageiro", JSON.stringify(dadosUsuario));
                
                exibirMensagemRapida("Registro conclu√≠do com sucesso!", "sucesso");
                
                await new Promise(resolve => setTimeout(resolve, 600));
                
                try {
                    const respostaRotas = await fetch(`${URL_SERVIDOR}?acao=rotas_disponiveis&t=${Date.now()}`);
                    const dadosRotas = await respostaRotas.json();
                    
                    if (dadosRotas.sucesso) {
                        exibirSelecaoDeRota(dadosRotas.rotas);
                    } else {
                        exibirSelecaoDeRota(Object.values(ROTAS));
                    }
                } catch (erro) {
                    console.log("Erro ao carregar rotas:", erro);
                    exibirSelecaoDeRota(Object.values(ROTAS));
                }
                
            } else {
                throw new Error(resultado.erro || "Falha no registro");
            }
            
        } catch (erro) {
            console.error("Erro no registro:", erro);
            
            const idUsuario = gerarIdPassageiro(nome, telefone);
            const dadosUsuario = {
                nome: nome,
                telefone: telefone,
                id_usuario: idUsuario,
                data_registro: new Date().toISOString()
            };
            
            localStorage.setItem("dados_passageiro", JSON.stringify(dadosUsuario));
            exibirMensagemRapida("Registro conclu√≠do (modo local)", "sucesso");
            exibirSelecaoDeRota(Object.values(ROTAS));
            
        } finally {
            indicador.style.display = "none";
        }
    }
    
    // ============================================
    // SELE√á√ÉO DE ROTA
    // ============================================
    function exibirSelecaoDeRota(rotas) {
        document.getElementById("telaCadastro").style.opacity = "0";
        
        setTimeout(() => {
            document.getElementById("telaCadastro").classList.add("oculto");
            document.getElementById("telaSelecaoRota").style.display = "flex";
            
            const container = document.getElementById("containerRotas");
            container.innerHTML = "";
            
            const rotasArray = Array.isArray(rotas) ? rotas : Object.values(ROTAS);
            
            rotasArray.forEach(rota => {
                const elemento = document.createElement("div");
                elemento.className = "opcao-rota";
                elemento.dataset.rota = rota.id;
                elemento.onclick = () => {
                    document.querySelectorAll('.opcao-rota').forEach(opcao => {
                        opcao.classList.remove('selecionada');
                    });
                    elemento.classList.add('selecionada');
                    rotaSelecionada = rota.id;
                };
                
                elemento.innerHTML = `
                    <div class="icone-rota">${rota.simbolo || 'üöÇ'}</div>
                    <div style="flex:1;">
                        <h3 style="color:white; margin:0 0 5px 0;">${rota.nome || 'Rota'}</h3>
                        <p style="color:#cbd5e1; margin:0;">Clique para selecionar</p>
                    </div>
                `;
                
                container.appendChild(elemento);
            });
            
            if (rotasArray.length > 0) {
                rotaSelecionada = rotasArray[0].id;
                setTimeout(() => {
                    const primeiraOpcao = container.querySelector('.opcao-rota');
                    if (primeiraOpcao) primeiraOpcao.classList.add('selecionada');
                }, 100);
            }
        }, 500);
    }
    
    function confirmarSelecaoRota() {
        if (!rotaSelecionada) {
            exibirMensagemRapida("Selecione uma rota para continuar", "erro");
            return;
        }
        
        localStorage.setItem('railtrack_rota_atual', rotaSelecionada);
        
        const dadosUsuario = JSON.parse(localStorage.getItem("dados_passageiro"));
        if (dadosUsuario && dadosUsuario.id_usuario) {
            try {
                const dadosFormulario = new URLSearchParams();
                dadosFormulario.append('acao', 'salvar_rota');
                dadosFormulario.append('id_usuario', dadosUsuario.id_usuario);
                dadosFormulario.append('rota', rotaSelecionada);
                
                fetch(URL_SERVIDOR, {
                    method: 'POST',
                    body: dadosFormulario
                }).catch(erro => console.log("Erro ao salvar rota:", erro));
            } catch (erro) {
                console.log("Erro ao salvar rota:", erro);
            }
        }
        
        document.getElementById("telaSelecaoRota").style.display = "none";
        iniciarSistemaPrincipal();
    }
    
    // ============================================
    // VERIFICA√á√ÉO INICIAL
    // ============================================
    async function verificarSessaoExistente() {
        const dadosUsuarioRaw = localStorage.getItem("dados_passageiro");
        
        if (dadosUsuarioRaw) {
            try {
                const dadosUsuario = JSON.parse(dadosUsuarioRaw);
                
                if (dadosUsuario.nome && dadosUsuario.telefone && dadosUsuario.id_usuario) {
                    usuarioAtual = gerarIdPassageiro(dadosUsuario.nome, dadosUsuario.telefone);
                    
                    const rotaSalva = localStorage.getItem('railtrack_rota_atual');
                    
                    if (rotaSalva && ROTAS[rotaSalva]) {
                        rotaSelecionada = rotaSalva;
                        
                        setTimeout(() => {
                            document.getElementById("telaCadastro").classList.add("oculto");
                            iniciarSistemaPrincipal();
                        }, 500);
                        
                    } else {
                        try {
                            const respostaRotas = await fetch(`${URL_SERVIDOR}?acao=rotas_disponiveis&t=${Date.now()}`);
                            const dadosRotas = await respostaRotas.json();
                            
                            if (dadosRotas.sucesso) {
                                exibirSelecaoDeRota(dadosRotas.rotas);
                            } else {
                                exibirSelecaoDeRota(Object.values(ROTAS));
                            }
                        } catch (erro) {
                            exibirSelecaoDeRota(Object.values(ROTAS));
                        }
                    }
                }
            } catch (e) {
                localStorage.removeItem("dados_passageiro");
            }
        }
    }
    
    // ============================================
    // INICIALIZA√á√ÉO DO SISTEMA PRINCIPAL
    // ============================================
    function iniciarSistemaPrincipal() {
        if (!rotaSelecionada) return;
        
        const infoRota = ROTAS[rotaSelecionada];
        if (infoRota) {
            document.getElementById("nomeRota").textContent = `RailTrack - ${infoRota.nome}`;
        }
        
        document.getElementById("conteudoPrincipal").classList.add("ativo");
        
        configurarMenu();
        configurarDetecaoScroll();
        carregarAtualizacoesRota();
        
        setInterval(() => carregarAtualizacoesRota(true), 30000);
        
        document.getElementById('botaoAtualizar').addEventListener('click', () => {
            const botao = document.getElementById('botaoAtualizar');
            botao.style.transform = 'rotate(360deg)';
            carregarAtualizacoesRota(false).finally(() => {
                setTimeout(() => {
                    botao.style.transform = '';
                }, 1000);
            });
        });
        
        document.getElementById('botaoConversa').addEventListener('click', () => {
            if (!rotaSelecionada) {
                exibirMensagemRapida("Selecione uma rota primeiro", "erro");
                return;
            }
            
            document.getElementById('telaConversa').style.display = 'flex';
            carregarMensagensConversa();
            iniciarVerificacaoConversa();
        });
        
        document.getElementById('enviar-mensagem').addEventListener('click', enviarMensagemConversa);
        document.getElementById('campo-mensagem').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                enviarMensagemConversa();
            }
        });
        
        atualizarStatusConexao();
        window.addEventListener('online', atualizarStatusConexao);
        window.addEventListener('offline', atualizarStatusConexao);
    }
    
    // ============================================
    // FUN√á√ïES DO SISTEMA PRINCIPAL
    // ============================================
    function configurarMenu() {
        const menu = document.getElementById('menuLateral');
        const sobreposicao = document.getElementById('sobreposicao');
        const botaoMenu = document.getElementById('botaoMenu');
        
        botaoMenu.addEventListener('click', () => {
            menu.classList.add('ativo');
            sobreposicao.classList.add('ativo');
        });
        
        sobreposicao.addEventListener('click', () => {
            menu.classList.remove('ativo');
            sobreposicao.classList.remove('ativo');
        });
    }
    
    async function carregarAtualizacoesRota(mostrarNotificacao = false) {
        if (!rotaSelecionada) return;
        
        const container = document.getElementById('containerAtualizacoes');
        const indicador = document.getElementById('indicadorCarregamento');
        
        indicador.style.display = 'flex';
        
        try {
            const url = `${URL_SERVIDOR}?acao=atualizacoes&rota=${rotaSelecionada}&t=${Date.now()}`;
            const resposta = await fetch(url);
            const dados = await resposta.json();
            
            if (dados.sucesso && dados.atualizacoes) {
                exibirAtualizacoes(dados.atualizacoes, container);
                
                if (mostrarNotificacao && dados.atualizacoes.length > contadorAtualizacoesAnterior) {
                    mostrarNotificacaoNova(dados.atualizacoes.length - contadorAtualizacoesAnterior);
                }
                contadorAtualizacoesAnterior = dados.atualizacoes.length;
                
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üöÇ</div>
                        <h3 style="color: #475569; margin-bottom: 10px;">Sem atualiza√ß√µes</h3>
                        <p style="color: #94a3b8;">Ainda n√£o h√° informa√ß√µes para esta rota</p>
                    </div>
                `;
            }
            
        } catch (erro) {
            console.error('Erro ao carregar atualiza√ß√µes:', erro);
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #ef4444;">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <h3 style="margin-bottom: 10px;">Falha na conex√£o</h3>
                    <p>${erro.message}</p>
                    <button onclick="carregarAtualizacoesRota()" style="margin-top: 20px; padding: 10px 20px; background: #1e40af; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Tentar Novamente
                    </button>
                </div>
            `;
        } finally {
            indicador.style.display = 'none';
            atualizarHoraVerificacao();
        }
    }
    
    function exibirAtualizacoes(atualizacoes, container) {
        if (!atualizacoes || atualizacoes.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üì≠</div>
                    <h3 style="margin-bottom: 10px;">Nenhuma atualiza√ß√£o</h3>
                    <p>Seja o primeiro a receber not√≠cias!</p>
                </div>
            `;
            return;
        }
        
        const atualizacoesOrdenadas = [...atualizacoes].sort((a, b) => 
            new Date(b.data_hora) - new Date(a.data_hora)
        );
        
        const html = atualizacoesOrdenadas.map((atualizacao, indice) => {
            let remetente = atualizacao.remetente || "Equipe RailTrack";
            if (!remetente.includes("üõ°Ô∏è")) {
                remetente = `üõ°Ô∏è ${remetente}`;
            }
            
            const hora = new Date(atualizacao.data_hora).toLocaleString('pt-MZ', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const conteudo = atualizacao.conteudo || '';
            const conteudoFormatado = conteudo
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            const nova = (Date.now() - new Date(atualizacao.data_hora).getTime()) < (5 * 60 * 60 * 1000);
            
            return `
                <div class="cartao-atualizacao ${nova ? 'nova' : ''}" style="animation-delay: ${indice * 0.05}s;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <span class="remetente">${remetente}</span>
                        <span class="data-hora">${hora}</span>
                    </div>
                    <div class="conteudo-mensagem">${conteudoFormatado}</div>
                    <div class="acoes-mensagem">
                        <button onclick="copiarTexto(\`${escaparTexto(conteudo)}\`)" class="botao-acao copiar" title="Copiar">
                            <i class="far fa-copy"></i> Copiar
                        </button>
                        <button onclick="compartilharAtualizacao(\`${escaparTexto(conteudo)}\`)" class="botao-acao compartilhar" title="Compartilhar">
                            <i class="fas fa-share-alt"></i> Compartilhar
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }
    
    function escaparTexto(texto) {
        return texto.replace(/`/g, "\\`").replace(/\n/g, "\\n");
    }
    
    function mostrarNotificacaoNova(quantidade) {
        const notificacao = document.getElementById('notificacaoNova');
        document.getElementById('textoNotificacao').textContent = 
            quantidade === 1 ? 'Nova atualiza√ß√£o!' : `${quantidade} novas atualiza√ß√µes!`;
        notificacao.style.display = 'flex';
        
        setTimeout(() => {
            notificacao.style.display = 'none';
        }, 8000);
        
        notificacao.onclick = () => {
            carregarAtualizacoesRota(false);
            notificacao.style.display = 'none';
        };
    }
    
    function configurarDetecaoScroll() {
        const areaConteudo = document.getElementById('areaConteudo');
        if (!areaConteudo) return;
        
        areaConteudo.addEventListener('scroll', () => {
            const proximoFim = areaConteudo.scrollHeight - areaConteudo.scrollTop - areaConteudo.clientHeight < 100;
        });
    }
    
    function atualizarHoraVerificacao() {
        const agora = new Date();
        const horaFormatada = agora.toLocaleTimeString('pt-MZ', { hour: '2-digit', minute: '2-digit' });
        const elemento = document.getElementById('ultimaAtualizacao');
        if (elemento) {
            elemento.innerHTML = `<i class="fas fa-clock"></i><span>√öltima: ${horaFormatada}</span>`;
        }
    }
    
    function copiarTexto(texto) {
        navigator.clipboard.writeText(texto).then(() => {
            const confirmacao = document.getElementById('confirmacaoCopia');
            confirmacao.style.display = 'flex';
            setTimeout(() => { confirmacao.style.display = 'none'; }, 2000);
        });
    }
    
    function compartilharAtualizacao(texto) {
        if (navigator.share) {
            navigator.share({ 
                title: 'Atualiza√ß√£o RailTrack', 
                text: texto.substring(0, 100) + '...', 
                url: window.location.href 
            });
        } else {
            copiarTexto(texto);
        }
    }
    
    function atualizarStatusConexao() {
        const status = document.getElementById('indicadorOnline');
        if (status) {
            const online = navigator.onLine;
            status.querySelector('span').textContent = online ? 'Online' : 'Offline';
            status.querySelector('.ponto-online').style.background = online ? '#10b981' : '#ef4444';
        }
    }
    
    // ============================================
    // SISTEMA DE CONVERSA
    // ============================================
    function obterIdUsuarioConversa() {
        const dadosUsuario = JSON.parse(localStorage.getItem("dados_passageiro"));
        
        if (dadosUsuario && dadosUsuario.nome && dadosUsuario.telefone) {
            try {
                const primeiroNome = dadosUsuario.nome.trim().split(/\s+/)[0];
                const telefoneLimpo = dadosUsuario.telefone.replace(/\D/g, '');
                const telefoneSemCodigo = telefoneLimpo.replace(/^258/, '');
                
                if (telefoneSemCodigo.length >= 7) {
                    return `${primeiroNome}_${telefoneSemCodigo}`;
                }
            } catch (e) {
                console.log("Erro ao processar usu√°rio:", e);
            }
        }
        
        let idConversa = localStorage.getItem("id_conversa_usuario");
        if (!idConversa) {
            const numeroAleatorio = Math.floor(1000000 + Math.random() * 9000000);
            idConversa = `Viajante_${numeroAleatorio}`;
            localStorage.setItem("id_conversa_usuario", idConversa);
        }
        
        return idConversa;
    }
    
    async function carregarMensagensConversa() {
        if (!rotaSelecionada) {
            document.getElementById('telaConversa').style.display = 'none';
            return;
        }
        
        const elemento = document.getElementById('areaMensagens');
        elemento.innerHTML = '<div class="carregando"><div class="spinner"></div></div>';
        
        try {
            const url = `${URL_SERVIDOR}?acao=conversa&rota=${rotaSelecionada}&t=${Date.now()}`;
            const resposta = await fetch(url);
            const dados = await resposta.json();
            
            if (dados.sucesso && dados.conversa && dados.conversa.length > 0) {
                const conversa = dados.conversa;
                conversa.sort((a, b) => new Date(a.data_hora) - new Date(b.data_hora));
                
                elemento.innerHTML = conversa.map(m => {
                    const usuarioAtual = obterIdUsuarioConversa();
                    const propriaMensagem = m.participante === usuarioAtual;
                    
                    const hora = new Date(m.data_hora).toLocaleTimeString('pt-MZ', {hour:'2-digit',minute:'2-digit'});
                    
                    return `
                        <div class="mensagem ${propriaMensagem ? 'enviada' : 'recebida'}">
                            <div style="font-weight:600; margin-bottom:4px; font-size:0.9rem;">${m.participante || 'Viajante'}</div>
                            <div>${m.mensagem || ''}</div>
                            <div style="text-align:right; margin-top:4px; font-size:0.75rem; color:#64748b;">${hora}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('tituloConversa').textContent = `Conversa - ${ROTAS[rotaSelecionada].nome}`;
                
                if (conversa.length > 0) {
                    const ultima = conversa[conversa.length - 1];
                    ultimaMensagemConversa = new Date(ultima.data_hora).getTime();
                }
                
                setTimeout(() => {
                    elemento.scrollTop = elemento.scrollHeight;
                }, 100);
                
            } else {
                elemento.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="font-size: 2.5rem; margin-bottom: 15px;">üí¨</div>
                        <h3 style="margin-bottom: 10px;">Conversa vazia</h3>
                        <p>Inicie a conversa com outros viajantes</p>
                    </div>
                `;
            }
            
        } catch (erro) {
            console.error('Erro ao carregar conversa:', erro);
            elemento.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #ef4444;">
                    <div style="font-size: 2rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <h3 style="margin-bottom: 10px;">Erro ao carregar</h3>
                    <p>${erro.message}</p>
                </div>
            `;
        }
    }
    
    async function enviarMensagemConversa() {
        if (!rotaSelecionada) {
            exibirMensagemRapida("Selecione uma rota primeiro", "erro");
            return;
        }
        
        const campo = document.getElementById('campo-mensagem');
        const botao = document.getElementById('enviar-mensagem');
        const mensagem = campo.value.trim();
        
        if (!mensagem) {
            exibirMensagemRapida("Digite uma mensagem", "erro");
            return;
        }
        
        if (mensagem.length > 300) {
            exibirMensagemRapida("Mensagem muito longa (m√°x. 300 caracteres)", "erro");
            return;
        }
        
        const textoOriginal = campo.value;
        campo.value = '';
        botao.disabled = true;
        
        try {
            const dadosFormulario = new URLSearchParams();
            dadosFormulario.append('acao', 'enviar_mensagem');
            dadosFormulario.append('mensagem', mensagem);
            dadosFormulario.append('participante', obterIdUsuarioConversa());
            dadosFormulario.append('rota', rotaSelecionada);
            
            const resposta = await fetch(URL_SERVIDOR, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: dadosFormulario.toString()
            });
            
            const resultado = await resposta.json();
            
            if (resultado.sucesso) {
                const horaAtual = new Date().toLocaleTimeString('pt-MZ', {hour:'2-digit', minute:'2-digit'});
                const container = document.getElementById('areaMensagens');
                
                const novaMensagemHTML = `
                    <div class="mensagem enviada">
                        <div style="font-weight:600; margin-bottom:4px; font-size:0.9rem;">${obterIdUsuarioConversa()}</div>
                        <div>${mensagem.replace(/[<>]/g, '')}</div>
                        <div style="text-align:right; margin-top:4px; font-size:0.75rem; color:#64748b;">${horaAtual}</div>
                    </div>
                `;
                
                if (container.innerHTML.includes('Conversa vazia')) {
                    container.innerHTML = novaMensagemHTML;
                } else {
                    container.innerHTML += novaMensagemHTML;
                }
                
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
                
                ultimaMensagemConversa = Date.now();
                
            } else {
                throw new Error(resultado.erro || 'Falha ao enviar');
            }
            
        } catch (erro) {
            console.error('Erro ao enviar mensagem:', erro);
            campo.value = textoOriginal;
            exibirMensagemRapida("Erro ao enviar: " + erro.message, "erro");
            
        } finally {
            botao.disabled = false;
            campo.focus();
        }
    }
    
    function iniciarVerificacaoConversa() {
        if (intervaloAtualizacao) clearInterval(intervaloAtualizacao);
        
        intervaloAtualizacao = setInterval(async () => {
            if (document.getElementById('telaConversa').style.display === 'flex') {
                await verificarNovasMensagens();
            }
        }, 3000);
    }
    
    async function verificarNovasMensagens() {
        try {
            const resposta = await fetch(`${URL_SERVIDOR}?acao=conversa&rota=${rotaSelecionada}&t=${Date.now()}`);
            const dados = await resposta.json();
            
            if (dados.sucesso && dados.conversa && dados.conversa.length > 0) {
                const ultimaMsg = dados.conversa[dados.conversa.length - 1];
                const ultimoTimestamp = new Date(ultimaMsg.data_hora).getTime();
                
                if (ultimoTimestamp > ultimaMensagemConversa) {
                    const meuUsuario = obterIdUsuarioConversa();
                    
                    if (ultimaMsg.participante !== meuUsuario) {
                        if (document.getElementById('telaConversa').style.display === 'flex') {
                            await carregarMensagensConversa();
                        } else {
                            notificarNovaMensagemConversa();
                        }
                    }
                    
                    ultimaMensagemConversa = ultimoTimestamp;
                }
            }
        } catch (e) {
            console.log('Erro ao verificar mensagens:', e);
        }
    }
    
    function notificarNovaMensagemConversa() {
        const badge = document.getElementById('badgeConversa');
        const atual = parseInt(badge.textContent) || 0;
        badge.textContent = atual + 1;
        badge.style.display = 'flex';
    }
    
    function fecharConversa() {
        document.getElementById('telaConversa').style.display = 'none';
        if (intervaloAtualizacao) {
            clearInterval(intervaloAtualizacao);
            intervaloAtualizacao = null;
        }
    }
    
    // ============================================
    // FUN√á√ïES ADICIONAIS DO MENU
    // ============================================
    function trocarRotaAtual() {
        if (confirm('Deseja trocar de rota?\nSer√° redirecionado para a sele√ß√£o de rotas.')) {
            document.getElementById('conteudoPrincipal').classList.remove('ativo');
            document.getElementById('menuLateral').classList.remove('ativo');
            document.getElementById('sobreposicao').classList.remove('ativo');
            exibirSelecaoDeRota(Object.values(ROTAS));
        }
    }
    
    function sairDoSistema() {
        if (confirm("Deseja sair do sistema?")) {
            localStorage.removeItem("dados_passageiro");
            localStorage.removeItem('railtrack_rota_atual');
            localStorage.removeItem("id_conversa_usuario");
            location.reload();
        }
    }
    
    function exibirInfoUsuario() {
        const dadosUsuario = JSON.parse(localStorage.getItem("dados_passageiro"));
        const rota = localStorage.getItem('railtrack_rota_atual');
        
        if (!dadosUsuario) {
            alert('Nenhum usu√°rio registrado!');
        } else {
            const nomeRota = rota ? ROTAS[rota]?.nome : 'Nenhuma';
            alert(`üë§ Perfil do Viajante\n\nNome: ${dadosUsuario.nome}\nTelefone: ${dadosUsuario.telefone}\nRota Atual: ${nomeRota}\nID: ${dadosUsuario.id_usuario}`);
        }
    }
    
    // ============================================
    // INICIALIZA√á√ÉO
    // ============================================
    window.addEventListener('DOMContentLoaded', () => {
        verificarSessaoExistente();
        
        window.addEventListener('visibilitychange', () => {
            if (!document.hidden && rotaSelecionada) {
                carregarAtualizacoesRota(true);
            }
        });
    });
  </script>
</body>
</html>
